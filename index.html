<!DOCTYPE html>
<html lang="tr" style="height: 100%;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERDƒ∞N√á TETƒ∞K katkƒ±larƒ±yla     Harita Bulmacasƒ± - Konum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS Kodlarƒ± */
        html, body {height: 100%; margin: 0; padding: 0; overflow-x: hidden; overflow-y: auto; font-family: 'Inter', sans-serif;}
        .harita-kapsayici {display: flex; width: 95%; height: 71vh; margin: 10px auto; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); border-radius: 12px; overflow: hidden;}
        #tahminKutusu {margin: 0; text-align: center; padding: 15px 20px; border: 1px solid #e0e0e0; background-color: #ffffff; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border-radius: 8px;}
        #solHaritaDiv {width: 100%; height: 100%; position: relative;}
        #sagHaritaDiv {height: 100%; width: 100%;}
        
        /* Tahmin Butonu Stili */
        /* Modern Buton Stili (Tahmin G√∂nder) */
#tahminButonu {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 12px 30px;
    border-radius: 99px; /* Tam oval */
    font-weight: 700;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    border: 2px solid transparent;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    letter-spacing: 0.5px;
}

#tahminButonu:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
    background: linear-gradient(135deg, #34d399 0%, #059669 100%);
}

#tahminButonu:active {
    transform: translateY(1px);
}

/* Sonraki A≈üama Butonu */
#sonrakiAsamaButonu {
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    /* ...diƒüer √∂zellikler yukarƒ±dakiyle aynƒ± mantƒ±kta... */
    border-radius: 12px;
}
   
        #sonrakiAsamaButonu:hover {
            background-color: #ea580c;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(249, 115, 22, 0.7);
        }

        /* SON 10 SANƒ∞YE CSS */
        .border-alert {
            border: 5px solid red !important;
            transition: border 0.5s ease-in-out;
        }
        
        /* YENƒ∞ EKLENEN ADIM SAYACI STƒ∞Lƒ∞ */
        #adimSayaciGosterge {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            color: white;
            text-align: center;
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            z-index: 10;
        }
        
        /* Gizleme Sƒ±nƒ±fƒ± */
        .hidden {
            display: none;
        }
        
        /* Responsive Ayarlar */
        @media (max-width: 768px) {
            #ustBolum { flex-direction: column; }
            .harita-kapsayici {flex-direction: column; height: 60vh;}
            #solHaritaDiv {width: 100%; height: 100%; border-left: none;}
            #sagHaritaKapsayici {width: 100% !important; height: 200px !important; border-top: 3px solid #374151; position: relative;}
            #sonucTablosuKapsayici {width: 100% !important; height: auto !important; margin-top: 10px;}
            #tahminKutusu {padding: 10px;}
            /* Mobil D√ºzeltme: Butonlar tam geni≈ülikte */
            #tahminButonu, #sonrakiAsamaButonu {margin-top: 5px; width: 100%; margin-left: 0 !important; font-size: 16px; padding: 10px 20px;}
        }
    </style>
</head>
<body class="bg-gray-50" onload="initMap()">
    
    <div id="baslangicKapsayici" class="flex flex-col items-center justify-center p-8 h-full w-full absolute top-0 left-0 z-50 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1524661135-423995f22d0b?q=80&w=1920&auto=format&fit=crop');">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>

    <div class="relative z-10 bg-white/10 backdrop-blur-md border border-white/20 p-8 rounded-2xl shadow-2xl flex flex-col items-center max-w-md w-full">
        <div class="mb-6 text-6xl">üåç</div>
        <h2 class="text-3xl font-bold text-white mb-2 drop-shadow-md">Harita Bulmacasƒ±</h2>
        <p class="text-gray-200 text-center mb-6 text-sm">Erdin√ß Tetik Sunar ‚Ä¢ 3 A≈üamalƒ± Meydan Okuma</p>
        
        <div id="kodGirisAlani" class="space-y-4 w-full">
            <input type="number" id="kod1" placeholder="Kod 1" class="w-full p-4 bg-white/80 border-0 rounded-xl text-center font-bold text-gray-800 focus:ring-4 focus:ring-blue-500/50 transition outline-none placeholder-gray-500" />
            <input type="number" id="kod2" placeholder="Kod 2" class="w-full p-4 bg-white/80 border-0 rounded-xl text-center font-bold text-gray-800 focus:ring-4 focus:ring-blue-500/50 transition outline-none placeholder-gray-500" />
            <input type="number" id="kod3" placeholder="Kod 3" class="w-full p-4 bg-white/80 border-0 rounded-xl text-center font-bold text-gray-800 focus:ring-4 focus:ring-blue-500/50 transition outline-none placeholder-gray-500" />
        </div>
        
        <button id="oyunuBaslatButonu" class="mt-8 w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold text-lg rounded-xl hover:from-blue-500 hover:to-indigo-500 transform hover:scale-[1.02] transition-all shadow-lg flex items-center justify-center gap-2">
            <span>Maceraya Ba≈üla</span> üöÄ
        </button>
        <p id="kodMesaj" class="mt-4 text-red-300 font-semibold text-sm hidden bg-red-900/50 p-2 rounded px-4"></p>
    </div>
</div>

    <div id="oyunKapsayici" class="h-full w-full hidden">
        
        <div id="ustBolum" class="flex w-full px-4 gap-4 items-start mx-auto" style="width: 95%; margin: 10px auto;">
            
            <div id="tahminKutusu" class="flex-grow">
                <h3 class="text-xl font-extrabold text-gray-800 mb-2">
                    <span role="img" aria-label="pin">üìç</span> Harita Bulmacasƒ± <span id="oyunBaslik"></span>
                </h3>
                <p class="text-lg font-mono mb-2">
                    ‚è≥ Kalan S√ºre: <span id="kronometre" class="text-red-600 font-bold">02:00</span>
                </p>
                <p id="hareketKalan" class="text-sm font-mono mb-4 text-gray-500">
                </p>
                <div class="flex flex-col md:flex-row items-center justify-center gap-2">
                    <button onclick="tahminGonder()" id="tahminButonu">
                        Tahmini G√∂nder
                    </button>
                    <button onclick="sonrakiAsamayaGec()" id="sonrakiAsamaButonu" class="hidden">
                        Sonraki Konum
                    </button>
                </div>
                <p id="mesajAlani" class="mt-1 text-sm font-semibold text-gray-700"></p>
            </div>

            <div id="sagHaritaKapsayici" style="height: 180px; width: 350px; border: 3px solid #374151; border-radius: 8px; overflow: hidden; flex-shrink: 0;">
                <div id="sagHaritaDiv">
                    </div>
            </div>

            <div id="sonucTablosuKapsayici" class="hidden" style="height: 250px; max-width: 500px; border: 3px solid #10b981; border-radius: 8px; flex-grow: 1; background-color: #f0fdf4;">
                <div class="p-3 overflow-y-auto h-full">
                    <h4 class="text-xl font-bold text-green-700 mb-2 border-b-2 border-green-200">Toplam Oyun √ñzeti üèÜ "Erdin√ß Tetik sunar"</h4>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-gray-600">
                                <th>Konum</th>
                                <th>Hedef Konum</th>
                                <th>Se√ßilen Konum</th>
                                <th class="text-right">Mesafe (km)</th>
                            </tr>
                        </thead>
                        <tbody id="sonucTablosuBody">
                            </tbody>
                        <tfoot>
                            <tr class="font-extrabold border-t-2 border-green-500 text-green-800">
                                <td colspan="3">TOPLAM</td>
                                <td id="toplamKm" class="text-right">0 km</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="harita-kapsayici">
            <div id="solHaritaDiv">
                
                <div id="streetViewContainer" style="width:100%; height:100%;">
                    </div>
                
                <div class="absolute top-0 left-0 w-full z-1 p-3 bg-gradient-to-r from-yellow-400 to-red-500 text-white font-extrabold text-xl shadow-lg flex justify-center items-center">
                    <span class="text-white text-xl font-extrabold ml-2"></span>
                    <button onclick="oyunuSifirlaParolaIle()" id="bannerSifirlaButonu" class="hidden text-lg px-3 py-1 bg-red-700 hover:bg-red-800 text-white font-bold rounded-lg transition duration-150">
                        üîÑ Oyunu Ba≈ütan Ba≈ülat
                    </button>
                </div>
                <div id="adimSayaciGosterge">
                    üë£ Kalan Adƒ±m: <span id="kalanAdimSayisi" class="text-white-400">100</span>
                </div>
            </div>
        </div>
    </div>
    
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxTyzKV_8MGCALG4lXVIvnAQHCS_EJdZM&libraries=places"></script>
    <script>
        // =========================================================================
        const SERIES_ID = 'PAROLA65.,.54.';
        // =========================================================================
        const SIFIRLAMA_PAROLASI = "1212"; 
        const MAX_HAREKET = 100; 
        let hareketSayaci = 0; 
        
        // üëá HEDEF VERƒ∞LERƒ∞ (Artƒ±k Sadece Koordinatlarƒ± ƒ∞√ßeriyor)
        // Uygulama otomatik olarak ismi √ßekecektir.
        const HEDEF_VERILERI = [
            { code: '1', coord: '56.155082, 86.002153' },
    { code: '2', coord: '-19.777115, -51.807649' },
    { code: '3', coord: '-29.932134, -58.314180' },
    { code: '4', coord: '11.980165, 124.855256' },
    { code: '5', coord: '34.436713, 133.332409' },
    { code: '6', coord: '60.069329, 20.094976' },
    { code: '7', coord: '-25.075241, -130.088754' },
    { code: '8', coord: '57.137273, 86.385653' },
    { code: '9', coord: '-28.798661, -65.107681' },
    
];

        // Se√ßilen koordinatlarƒ± tutan global deƒüi≈ükenler
        let selectedLat = null;
        let selectedLng = null;
        
        // üëá TOTAL_STAGES artƒ±k sabittir
        const TOTAL_STAGES = 3; 
        const TIMER_DURATION_SECONDS = 120; 

        // LOCAL STORAGE ANAHTARLARI
        const PREFIX = `${SERIES_ID}_`;
        const STORAGE_KEY_STAGE = `${PREFIX}haritaBulmacasi_current_stage`;
        const STORAGE_KEY_COMPLETED = `${PREFIX}haritaBulmacasi_oyun_tamamlandi`; 
        const STORAGE_KEY_HEDEF_ISIM_BASE = `${PREFIX}haritaBulmacasi_stage_`; 
        
        // Current Stage Num artƒ±k initMap'te belirlenecek, ancak anahtarlar i√ßin varsayƒ±lan bir deƒüer olmalƒ±
        const currentStageNumFromStorage = parseInt(localStorage.getItem(STORAGE_KEY_STAGE) || '0', 10);
        
        let CURRENT_STAGE_NUM = currentStageNumFromStorage === 0 ? 1 : currentStageNumFromStorage;
        const GAME_ID = `stage_${CURRENT_STAGE_NUM}`;
        
        const STORAGE_KEY_TAHMIN = `${PREFIX}haritaBulmacasi_${GAME_ID}_tahminYapildi`;
        const STORAGE_KEY_KOORDINAT = `${PREFIX}haritaBulmacasi_${GAME_ID}_tahminKoordinat`;
        const STORAGE_KEY_HEDEF = `${PREFIX}haritaBulmacasi_${GAME_ID}_hedefKoordinat`;
        const STORAGE_KEY_MESAFE = `${PREFIX}haritaBulmacasi_${GAME_ID}_mesafe`;
        const STORAGE_KEY_SELECTION_NAME = `${PREFIX}haritaBulmacasi_${GAME_ID}_selectionName`; 
        const STORAGE_KEY_SELECTION_COUNTRY_CODE = `${PREFIX}haritaBulmacasi_${GAME_ID}_selectionCountryCode`; 

        const STORAGE_KEY_TIMER_START = `${PREFIX}haritaBulmacasi_${GAME_ID}_timer_start`; 
        const STORAGE_KEY_TIMER_DURATION = `${PREFIX}haritaBulmacasi_${GAME_ID}_timer_duration`; 
        const STORAGE_KEY_HAREKET_SAYACI = `${PREFIX}haritaBulmacasi_${GAME_ID}_hareket_sayaci`; 
        
        let tahminHaritasi;
        let geocoder;
        let tahminMarker;
        let hedefMarker;
        let mesafeCizgisi; 
        let kronometreInterval;
        let tumAsamaMarkerlari = []; 
        let streetViewPanorama; 

        let warningControlDiv; 
        let uyariGosterildi = false; 

        // üëá YENƒ∞ FONKSƒ∞YON: √úlke kodunu bayrak emojisine d√∂n√º≈üt√ºr√ºr.
        function countryCodeToFlag(countryCode) {
            if (!countryCode || countryCode.length !== 2) return '';
            const codePoints = countryCode.toUpperCase().split('').map(char => 127397 + char.charCodeAt(0));
            return String.fromCodePoint(...codePoints);
        }

        // üëá Bayrak emojisini renkli bir SVG i≈üaret√ßisi ikonuna d√∂n√º≈üt√ºr√ºr.
        function createFlagMarkerIcon(flagEmoji, color) {
            const size = 36; 
            const fontSize = 28; 

            // Bayrak emojisini ortasƒ±na yerle≈ütiren ve renkli bir daire arka planƒ± olan SVG
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${size} ${size}" width="${size}" height="${size}">
                <circle cx="${size / 2}" cy="${size / 2}" r="${size / 2 - 2}" fill="${color}" stroke="#000" stroke-width="1.5"/>
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="${fontSize}" style="font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', Arial, sans-serif; cursor: pointer;">${flagEmoji}</text>
            </svg>`;
            
            const encodedSvg = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);

            return {
                url: encodedSvg,
                scaledSize: new google.maps.Size(size, size), 
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(size / 2, size / 2) 
            };
        }
        
        // =========================================================================
        // YENƒ∞ BA≈ûLANGI√á MANTIKLARI
        // =========================================================================

        document.addEventListener('DOMContentLoaded', () => {
            const baslatButonu = document.getElementById('oyunuBaslatButonu');
            const baslangicKapsayici = document.getElementById('baslangicKapsayici');
            const oyunKapsayici = document.getElementById('oyunKapsayici');
            
            if (baslatButonu) {
                baslatButonu.addEventListener('click', baslangiciKontrolEt);
            }
            
            const isGameStarted = localStorage.getItem(STORAGE_KEY_STAGE) && localStorage.getItem(`${STORAGE_KEY_HEDEF_ISIM_BASE}1_hedefEnlem`);

            if (localStorage.getItem(STORAGE_KEY_COMPLETED) === 'true' || isGameStarted) {
                // Oyun tamamlanmƒ±≈üsa veya a≈üama bilgisi varsa, oyun ekranƒ±nƒ± g√∂ster
                if (baslangicKapsayici && oyunKapsayici) {
                    baslangicKapsayici.classList.add('hidden');
                    oyunKapsayici.classList.remove('hidden');
                    // initMap onload ile zaten √ßaƒürƒ±lƒ±yor
                }
            } else {
                // Oyun ba≈ülamadƒ±ysa veya sƒ±fƒ±rlandƒ±ysa, ba≈ülangƒ±√ß ekranƒ±nƒ± g√∂ster
                if (baslangicKapsayici && oyunKapsayici) {
                    baslangicKapsayici.classList.remove('hidden');
                    oyunKapsayici.classList.add('hidden');
                    
                    // üëá YENƒ∞ EK: ƒ∞lk kod giri≈ü alanƒ±na odaklan
                    const kod1Input = document.getElementById('kod1');
                    if (kod1Input) {
                        kod1Input.focus();
                    }
                }
            }
        });


        // Kullanƒ±cƒ±nƒ±n girdiƒüi kodlarƒ± kontrol eder ve oyunu ba≈ülatƒ±r
        function baslangiciKontrolEt() {
            const kod1 = document.getElementById('kod1').value.trim();
            const kod2 = document.getElementById('kod2').value.trim();
            const kod3 = document.getElementById('kod3').value.trim();
            const kodMesaj = document.getElementById('kodMesaj');
            kodMesaj.classList.add('hidden');

            const girilenKodlar = [kod1, kod2, kod3];
            const secilenHedefler = [];
            const kullanilanKodlar = new Set();
            let gecersizKod = false;

            for (let i = 0; i < TOTAL_STAGES; i++) {
                const kod = girilenKodlar[i];
                
                if (kod.length !== 1) {
                    gecersizKod = true;
                    break;
                }

                if (kullanilanKodlar.has(kod)) {
                    kodMesaj.textContent = `Hata: Kodlar tekrar edemez. (${kod})`;
                    kodMesaj.classList.remove('hidden');
                    return;
                }

                // HEDEF_VERILERI dizisinde kodu ara
                const hedef = HEDEF_VERILERI.find(data => data.code === kod);

                if (!hedef) {
                    kodMesaj.textContent = `Hata: ${kod} kodu listede bulunamadƒ±.`;
                    kodMesaj.classList.remove('hidden');
                    return;
                }

                secilenHedefler.push(hedef);
                kullanilanKodlar.add(kod);
            }

            if (gecersizKod || secilenHedefler.length !== TOTAL_STAGES) {
                kodMesaj.textContent = 'Hata: L√ºtfen 3 adet ge√ßerli ve 4 haneli, benzersiz kod girin.';
                kodMesaj.classList.remove('hidden');
                return;
            }
            
            // Kodlar ge√ßerliyse, hedefleri localStorage'a kaydet
            secilenHedefler.forEach((hedef, index) => {
                const stageNum = index + 1;
                
                // Koordinat Stringini Enlem ve Boylama Ayƒ±r
                const parts = hedef.coord.split(',').map(p => p.trim());
                const hedefLat = parseFloat(parts[0]);
                const hedefLng = parseFloat(parts[1]);
                
                if (isNaN(hedefLat) || isNaN(hedefLng)) {
                    console.error(`Koordinat ayrƒ±≈ütƒ±rma hatasƒ±: ${hedef.coord}`);
                    kodMesaj.textContent = `Hata: ${hedef.code} kodunun koordinat formatƒ± ge√ßersiz.`;
                    kodMesaj.classList.remove('hidden');
                    return;
                }

                // Koordinatlarƒ± ve ismi a≈üamaya √∂zel anahtarlarla kaydet
                localStorage.setItem(`${STORAGE_KEY_HEDEF_ISIM_BASE}${stageNum}_hedefEnlem`, hedefLat);
                localStorage.setItem(`${STORAGE_KEY_HEDEF_ISIM_BASE}${stageNum}_hedefBoylam`, hedefLng);
                // üëá HEDEF ADI KAYIT MANTIƒûI: Veri setinde isim yoksa (veya bo≈üsa) kodu kaydet. initMap'te ger√ßek ismi √ßekeceƒüiz.
                localStorage.setItem(`${STORAGE_KEY_HEDEF_ISIM_BASE}${stageNum}_hedefIsim`, hedef.name || `Hedef ${hedef.code}`);
                localStorage.setItem(`${STORAGE_KEY_HEDEF_ISIM_BASE}${stageNum}_hedefKoordinat`, hedef.coord); // Tahmin ekranƒ± i√ßin string formatƒ± kaydet
            });

            // Oyunu ba≈ülat ve aray√ºz√º deƒüi≈ütir
            localStorage.setItem(STORAGE_KEY_STAGE, 1); // Oyunu 1. a≈üamadan ba≈ülat
            localStorage.removeItem(STORAGE_KEY_COMPLETED); // Tamamlandƒ± bilgisini sƒ±fƒ±rla
            
            document.getElementById('baslangicKapsayici').classList.add('hidden');
            document.getElementById('oyunKapsayici').classList.remove('hidden');
            
            // initMap'i √ßaƒüƒ±r
            if (typeof initMap === 'function') {
                initMap(); 
            } else {
                window.location.reload(); // Gerekirse sayfayƒ± tamamen yenile
            }
        }

        // =========================================================================
        // HARƒ∞TA VE OYUN MANTIKLARI
        // =========================================================================

        // API y√ºklendikten sonra haritalarƒ± ba≈ülatan ana fonksiyon
        async function initMap() {
            const CURRENT_STAGE_NUM = parseInt(localStorage.getItem(STORAGE_KEY_STAGE) || '0', 10);
            
            if (localStorage.getItem(STORAGE_KEY_COMPLETED) === 'true' || CURRENT_STAGE_NUM === 0) {
                if (CURRENT_STAGE_NUM !== 0) {
                    gosterToplamSonuclari(); // Tamamlandƒ±ysa sonu√ßlarƒ± g√∂ster
                }
                return; 
            }
            
            // A≈üama Ba≈ülƒ±ƒüƒ±nƒ± G√ºncelle
            document.getElementById('oyunBaslik').textContent = `(Konum ${CURRENT_STAGE_NUM} / ${TOTAL_STAGES})`;

            // YENƒ∞: Koordinatlarƒ± localStorage'dan √ßek
            const stageKey = `${STORAGE_KEY_HEDEF_ISIM_BASE}${CURRENT_STAGE_NUM}`;
            const HEDEF_ENLEM = parseFloat(localStorage.getItem(`${stageKey}_hedefEnlem`));
            const HEDEF_BOYLAM = parseFloat(localStorage.getItem(`${stageKey}_hedefBoylam`));
            const HEDEF_KOORDINAT_STRING = localStorage.getItem(`${stageKey}_hedefKoordinat`);

            // Eƒüer koordinatlar y√ºklenemezse (Kod giri≈üi atlanmƒ±≈üsa)
            if (isNaN(HEDEF_ENLEM) || isNaN(HEDEF_BOYLAM)) {
                if (CURRENT_STAGE_NUM > 0) {
                    // Eƒüer oyun ba≈ülamƒ±≈ü g√∂r√ºn√ºyorsa ama koordinat yoksa, sƒ±fƒ±rla ve ba≈ülangƒ±√ß ekranƒ±na d√∂n
                    resetGame(); 
                }
                return; 
            }
            
            // Street View'u ba≈ülat
            streetViewPanorama = new google.maps.StreetViewPanorama(
                document.getElementById('streetViewContainer'), {
                    position: { lat: HEDEF_ENLEM, lng: HEDEF_BOYLAM }, 
                    pov: { heading: 270, pitch: 0 },
                    linksControl: false,
                    panControl: false,
                    zoomControl: false,
                    fullscreenControl: true, 
                    addressControl: false,
                    visible: true
                });

            hareketSayaci = parseInt(localStorage.getItem(STORAGE_KEY_HAREKET_SAYACI) || '0', 10);
            guncelleHareketGostergesi(); 

            geocoder = new google.maps.Geocoder();
            
            const hedefIsimKey = `${stageKey}_hedefIsim`;
            let hedefIsmi = localStorage.getItem(hedefIsimKey); 
            
            const hedefUlkeKoduKey = `${STORAGE_KEY_HEDEF_ISIM_BASE}${CURRENT_STAGE_NUM}_hedefUlkeKodu`;
            let hedefUlkeKodu = localStorage.getItem(hedefUlkeKoduKey);


            // üëá YENƒ∞ EK: Eƒüer hedef ismi hala "Hedef XXXX" ≈üeklinde koddan olu≈üuyorsa VEYA √ºlke kodu eksikse, geocoding yap.
            if (!hedefUlkeKodu || (hedefIsmi && hedefIsmi.startsWith('Hedef '))) { 
                document.getElementById('mesajAlani').textContent = "Konum bilgileri alƒ±nƒ±yor...";
                
                // getKonumAdiByKoordinat fonksiyonu hem ismi hem kodu d√∂nd√ºr√ºyor.
                const { locationName: newHedefIsmi, countryCode: newHedefUlkeKodu } = await getKonumAdiByKoordinat(HEDEF_ENLEM, HEDEF_BOYLAM);
                
                // Yeni bilgileri kaydet
                hedefIsmi = newHedefIsmi;
                hedefUlkeKodu = newHedefUlkeKodu;
                localStorage.setItem(hedefUlkeKoduKey, hedefUlkeKodu); 
                localStorage.setItem(hedefIsimKey, hedefIsmi); 
                
                document.getElementById('mesajAlani').textContent = ""; 
            }
            // üëÜ YENƒ∞ EK Bƒ∞Tƒ∞≈û
            

            // Saƒüdaki haritayƒ± ba≈ülat
            tahminHaritasi = new google.maps.Map(document.getElementById('sagHaritaDiv'), {
                center: { lat: 41, lng: 28 }, 
                zoom: 2,
                streetViewControl: false,
                mapTypeControl: false,
                fullscreenControl: true,
                zoomControl: false,
                gestureHandling: "greedy" // Harita Mouse Tekerleƒüi Zoom Fix'i
            });
            
            // Harita konteyneri display:none'dan √ßƒ±ktƒ±ƒüƒ±nda kendini doƒüru boyutlandƒ±rmasƒ±nƒ± saƒülar.
            google.maps.event.addListenerOnce(tahminHaritasi, 'idle', function() {
                google.maps.event.trigger(tahminHaritasi, 'resize');
                tahminHaritasi.setCenter({ lat: 41, lng: 28 });
                tahminHaritasi.setZoom(2);
            });
            
            // Haritaya tƒ±klama olayƒ±nƒ± ekle
            tahminHaritasi.addListener('click', (event) => {
                // YENƒ∞ KONTROL: Eƒüer tahmin yapƒ±lmƒ±≈üsa veya oyun bitmi≈üse tƒ±klamayƒ± engelle
                if (localStorage.getItem(STORAGE_KEY_TAHMIN) === 'true' || localStorage.getItem(STORAGE_KEY_COMPLETED) === 'true') {
                    document.getElementById('mesajAlani').textContent = "‚ö†Ô∏è Tahmin zaten yapƒ±ldƒ± veya oyun bitti. Sonraki Konuma Ge√ßin.";
                    return;
                }

                const lat = event.latLng.lat();
                const lng = event.latLng.lng();
                
                pinAtVeKoordinatGuncelle(lat, lng);

                // Pin se√ßildiƒüinde butonu etkinle≈ütir.
                document.getElementById('tahminButonu').disabled = false;
                
                document.getElementById('mesajAlani').textContent = "Koordinat se√ßildi. Tahmini G√∂ndermek i√ßin Butona Basƒ±n.";
            });
            
            // Harita √ºzerine uyarƒ± kontrol√ºn√º ekle
            createCustomControl(); 

            const tahminYapildi = localStorage.getItem(STORAGE_KEY_TAHMIN) === 'true';
            
            if (tahminYapildi) {
                const tahminKoordinatStr = localStorage.getItem(STORAGE_KEY_KOORDINAT);
                const hedefKoordinatStr = HEDEF_KOORDINAT_STRING; // Hedef koordinatƒ± local'den √ßek
                const selectionCountryCode = localStorage.getItem(STORAGE_KEY_SELECTION_COUNTRY_CODE);
                const hedefCountryCode = localStorage.getItem(hedefUlkeKoduKey); 
                
                const [tahminEnlem, tahminBoylam] = tahminKoordinatStr ? tahminKoordinatStr.split(',').map(p => parseFloat(p.trim())) : [0, 0];
                const [hedefEnlem, hedefBoylam] = hedefKoordinatStr ? hedefKoordinatStr.split(',').map(p => parseFloat(p.trim())) : [0, 0];

                document.getElementById('tahminButonu').disabled = true;
                document.getElementById('tahminButonu').classList.add('hidden');
                document.getElementById('sonrakiAsamaButonu').classList.remove('hidden');

                // Tekrar g√∂sterim i√ßin pinleri g√∂ster
                setTimeout(() => {
                    gosterPinlerVeHaritayiYakƒ±nla≈ütƒ±r(tahminEnlem, tahminBoylam, hedefEnlem, hedefBoylam, selectionCountryCode, hedefCountryCode);
                }, 250);
            } else {
                tahminHaritasi.setZoom(2);
                tahminHaritasi.setCenter({ lat: 41, lng: 28 });
                document.getElementById('tahminButonu').classList.remove('hidden');
                document.getElementById('tahminButonu').disabled = true; // ƒ∞lk ba≈üta tahmin butonu devre dƒ±≈üƒ± (se√ßim yapmaya zorlamak i√ßin)

                const display = document.getElementById('kronometre');
                startTimer(TIMER_DURATION_SECONDS, display);

                if (hareketSayaci >= MAX_HAREKET) {
                    streetViewPanorama.setOptions({ linksControl: false, panControl: false, zoomControl: false });
                    document.getElementById('mesajAlani').textContent = "‚õî **ADIM KISITI A≈ûILDI!** Street View'da ileri/geri gidemezsiniz.";
                } else {
                    streetViewPanorama.setOptions({ linksControl: true, panControl: true, zoomControl: true });
                    google.maps.event.addListener(streetViewPanorama, 'position_changed', artirHareketSayaci);
                }
            }
        }
        
        // =================================================================================================
        // HAREKET KISITLAMA FONKSƒ∞YONLARI 
        // =================================================================================================

        function guncelleHareketGostergesi() {
            const adimSayisiGostergesi = document.getElementById('kalanAdimSayisi');
            if (!adimSayisiGostergesi) return;
            
            const kalan = MAX_HAREKET - hareketSayaci;
            const renkSinifi = kalan <= 10 ? 'text-red-400 animate-pulse' : 'text-white-400';
            
            adimSayisiGostergesi.textContent = kalan;
            adimSayisiGostergesi.className = renkSinifi; 
        }

        function artirHareketSayaci() {
            if (localStorage.getItem(STORAGE_KEY_TAHMIN) === 'true') {
                return;
            }
            
            if (hareketSayaci >= MAX_HAREKET) {
                streetViewPanorama.setOptions({ linksControl: false, panControl: false, zoomControl: false });
                document.getElementById('mesajAlani').textContent = "‚õî **ADIM KISITI A≈ûILDI!** Street View'da ileri/geri gidemezsiniz.";
                return;
            }

            hareketSayaci++;
            localStorage.setItem(STORAGE_KEY_HAREKET_SAYACI, hareketSayaci);
            guncelleHareketGostergesi();

            if (hareketSayaci >= MAX_HAREKET) {
                streetViewPanorama.setOptions({ linksControl: false, panControl: false, zoomControl: false });
                document.getElementById('mesajAlani').textContent = "‚õî **ADIM KISITI A≈ûILDI!** Street View'da ileri/geri gidemezsiniz.";
            } else if (hareketSayaci > MAX_HAREKET - 10) {
                document.getElementById('mesajAlani').textContent = `‚ö†Ô∏è Son ${MAX_HAREKET - hareketSayaci} adƒ±m kaldƒ±!`;
            }
        }
        
        // =================================================================================================
        // GOOGLE MAPS √ñZEL KONTROL FONKSƒ∞YONLARI 
        // =================================================================================================
        
        // Sadece uyarƒ±yƒ± gizler
        function kapatUyari() {
            if (warningControlDiv) {
                warningControlDiv.style.display = 'none'; // Kontrol√º gizle
            }
        }
        
        // Global tƒ±klama olayƒ±nƒ± y√∂netir
        function kapatUyariGlobal(event) {
            // Uyarƒ±nƒ±n kapandƒ±ƒüƒ±ndan emin ol
            kapatUyari();
            
            // Dinleyiciyi hemen kaldƒ±r
            document.removeEventListener('click', kapatUyariGlobal, true);
        }

        function createCustomControl() {
            // 1. Dƒ±≈ü konteyner Div'i olu≈ütur
            warningControlDiv = document.createElement('div');
            warningControlDiv.style.margin = '10px';
            warningControlDiv.style.padding = '10px 15px';
            warningControlDiv.style.backgroundColor = 'rgba(239, 68, 68, 0.95)'; // Tailwind bg-red-500
            warningControlDiv.style.color = 'white';
            warningControlDiv.style.borderRadius = '8px';
            warningControlDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
            warningControlDiv.style.display = 'none'; // Ba≈ülangƒ±√ßta gizle
            warningControlDiv.style.maxWidth = '250px';
            warningControlDiv.style.textAlign = 'center';
            
            // 2. ƒ∞√ßerik Span'i olu≈ütur
            const controlText = document.createElement('span');
            controlText.style.fontWeight = 'bold';
            controlText.style.fontSize = '14px';
            controlText.innerHTML = '‚ö†Ô∏è SON 30 SANƒ∞YE! S√ºre bitiyor. Kapatmak i√ßin herhangi bir yere tƒ±klayƒ±n.';
            
            warningControlDiv.appendChild(controlText);
            
            // 4. Kontrol√º Haritaya Ekle (Saƒü √úst K√∂≈üe)
            if (tahminHaritasi) {
                tahminHaritasi.controls[google.maps.ControlPosition.TOP_RIGHT].push(warningControlDiv);
            }
        }

        function gosterGeciciUyari() {
            if (warningControlDiv) {
                warningControlDiv.style.display = 'block'; 

                // HARƒ∞TA TAM EKRANDAYKEN DAHƒ∞ √áALI≈ûMASI ƒ∞√áƒ∞N document √ºzerine olay dinleyicisi eklenir.
                document.addEventListener('click', kapatUyariGlobal, true);
            }
        }
        
        // =================================================================================================
        // Dƒ∞ƒûER FONKSƒ∞YONLAR 
        // =================================================================================================

        // Hem konum adƒ±nƒ± hem de √ºlke kodunu d√∂nd√ºr√ºr
        async function getKonumAdiByKoordinat(lat, lng) {
            return new Promise((resolve) => {
                if (!geocoder) {
                    return resolve({ locationName: "Y√ºkleniyor...", countryCode: '' });
                }
                const latlng = { lat: lat, lng: lng };
                geocoder.geocode({ location: latlng }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        const components = results[0].address_components;
                        
                        let country = components.find(c => c.types.includes('country'))?.long_name;
                        let countryCode = components.find(c => c.types.includes('country'))?.short_name || ''; 
                        
                        let city = null;
                        const cityTypes = ['locality', 'postal_town', 'administrative_area_level_1', 'administrative_area_level_2'];

                        for (const component of components) {
                            if (component.types.some(type => cityTypes.includes(type))) {
                                city = component.long_name;
                                break; 
                            }
                        }
                        
                        if (city && country && city === country) {
                            city = null;
                        }

                        const locationName = `${city || ''}, ${country || ''}`
                                .replace(/^, | ,$/g, '') 
                                .trim();
                        
                        resolve({ locationName: locationName || "Bilinmiyor", countryCode: countryCode });
                        
                    } else {
                        console.error("Geocoding ba≈üarƒ±sƒ±z oldu:", status);
                        resolve({ locationName: "Bilinmiyor", countryCode: '' });
                    }
                });
            });
        }

        async function tahminGonder() {
             if (selectedLat === null || selectedLng === null) {
                 document.getElementById('mesajAlani').textContent = "‚ö†Ô∏è L√ºtfen √∂nce haritadan bir konum se√ßiniz.";
                 return;
             }
             
             const stageNum = parseInt(localStorage.getItem(STORAGE_KEY_STAGE));
             const stageKey = `${STORAGE_KEY_HEDEF_ISIM_BASE}${stageNum}`;

             const HEDEF_ENLEM = parseFloat(localStorage.getItem(`${stageKey}_hedefEnlem`));
             const HEDEF_BOYLAM = parseFloat(localStorage.getItem(`${stageKey}_hedefBoylam`));
             const HEDEF_KOORDINAT_STRING = localStorage.getItem(`${stageKey}_hedefKoordinat`);

             const tahminEnlem = selectedLat;
             const tahminBoylam = selectedLng;

             if (!tahminHaritasi) {
                 document.getElementById('mesajAlani').textContent = "Harita y√ºklenmeden tahmin g√∂nderilemez.";
                 return;
             }
             
             document.getElementById('mesajAlani').textContent = "Konum adƒ± alƒ±nƒ±yor, l√ºtfen bekleyin...";
             document.getElementById('tahminButonu').disabled = true;

             // Se√ßilen konumun adƒ±nƒ± ve kodunu al
             const { locationName: selectionName, countryCode: selectionCountryCode } = await getKonumAdiByKoordinat(tahminEnlem, tahminBoylam);

             // Hedef √ºlke kodunu al (initMap'te kaydedildi)
             const hedefUlkeKoduKey = `${STORAGE_KEY_HEDEF_ISIM_BASE}${stageNum}_hedefUlkeKodu`;
             const hedefCountryCode = localStorage.getItem(hedefUlkeKoduKey) || ''; 
             
             // Pinleri g√∂sterirken hem tahmin hem de hedefin √ºlke kodlarƒ±nƒ± g√∂nder
             gosterPinlerVeHaritayiYakƒ±nla≈ütƒ±r(tahminEnlem, tahminBoylam, HEDEF_ENLEM, HEDEF_BOYLAM, selectionCountryCode, hedefCountryCode);

             const mesafeKm = getDistance(HEDEF_ENLEM, HEDEF_BOYLAM, tahminEnlem, tahminBoylam);
             let formattedMesafe;
             let kaydedilecekMesafe; 

             kaydedilecekMesafe = mesafeKm.toString(); // Tam ondalƒ±klƒ± deƒüeri kaydet
            
             const FACTOR = 100;
             const truncatedMesafe = Math.trunc(mesafeKm * FACTOR) / FACTOR; // 2 ondalƒ±kta kes

             formattedMesafe = truncatedMesafe.toLocaleString('tr-TR', { 
                 minimumFractionDigits: 2, 
                 maximumFractionDigits: 2 
             });

             const hedefIsimKey = `${STORAGE_KEY_HEDEF_ISIM_BASE}${stageNum}_hedefIsim`;
             // üëá Hedef ismi localStorage'dan √ßekilir (initMap'te g√ºncellendi)
             const hedefIsmi = localStorage.getItem(hedefIsimKey) || `Konum ${stageNum}`; 
             
             // Bayraklarƒ± olu≈ütur
             const selectionFlag = countryCodeToFlag(selectionCountryCode);
             const hedefFlag = countryCodeToFlag(hedefCountryCode);

             document.getElementById('mesajAlani').innerHTML =
                 `‚úÖ Ger√ßek Konum: <b class="text-green-600">${hedefFlag} ${hedefIsmi}</b> <br> Se√ßim: <b class="text-red-600">${selectionFlag} ${selectionName}</b> <br> Hedefe uzaklƒ±k: <span class="text-blue-600 font-bold">${formattedMesafe} km</span>`;

             
             localStorage.setItem(STORAGE_KEY_TAHMIN, 'true');
             // Hedef koordinat stringini tekrar kaydet
             localStorage.setItem(STORAGE_KEY_HEDEF, HEDEF_KOORDINAT_STRING); 
             localStorage.setItem(STORAGE_KEY_KOORDINAT, `${tahminEnlem.toFixed(6)}, ${tahminBoylam.toFixed(6)}`);
             localStorage.setItem(STORAGE_KEY_MESAFE, kaydedilecekMesafe); 
             // Se√ßilen √ºlke kodunu kaydet
             localStorage.setItem(STORAGE_KEY_SELECTION_COUNTRY_CODE, selectionCountryCode); 
             // Tablo i√ßin bayraklƒ± ismi kaydet
             localStorage.setItem(STORAGE_KEY_SELECTION_NAME, `${selectionFlag} ${selectionName}`); 

             clearInterval(kronometreInterval);
             localStorage.removeItem(STORAGE_KEY_TIMER_START);
             localStorage.removeItem(STORAGE_KEY_TIMER_DURATION);
             
             document.body.classList.remove('border-alert'); 

             const display = document.getElementById('kronometre');
             display.textContent = "00:00";
             display.style.color = "gray";
             display.classList.remove("animate-pulse");

             document.getElementById('tahminButonu').classList.add('hidden');
             document.getElementById('sonrakiAsamaButonu').classList.remove('hidden');
             
             if (streetViewPanorama) {
                 streetViewPanorama.setOptions({ linksControl: true, panControl: true, zoomControl: true });
             }


             if (stageNum === TOTAL_STAGES) {
                 gosterToplamSonuclari();
                 document.getElementById('sonrakiAsamaButonu').textContent = "üîÑ Oyunu Ba≈ütan Ba≈ülat"; 
             } else {
                 document.getElementById('sonrakiAsamaButonu').textContent = `üëâ Sonraki Konum (${stageNum + 1}. A≈üama)`;
             }
        }

        
        function gosterTumAsamaSonuclarini() {
             temizleHaritaKatmanlari(); 

             const bounds = new google.maps.LatLngBounds(); 

             for (let i = 0; i < TOTAL_STAGES; i++) {
                 const stageNum = i + 1;
                 
                 const kaydedilenTahminStr = localStorage.getItem(`${PREFIX}haritaBulmacasi_stage_${stageNum}_tahminKoordinat`);
                 const kaydedilenHedefStr = localStorage.getItem(`${PREFIX}haritaBulmacasi_stage_${stageNum}_hedefKoordinat`);

                 // Hedef Bilgileri
                 const hedefUlkeKoduKey = `${STORAGE_KEY_HEDEF_ISIM_BASE}${stageNum}_hedefUlkeKodu`;
                 const hedefCountryCode = localStorage.getItem(hedefUlkeKoduKey) || ''; 
                 const hedefFlag = countryCodeToFlag(hedefCountryCode);
                 // üëá Hedef ismi localStorage'dan √ßekilir
                 const hedefName = localStorage.getItem(`${STORAGE_KEY_HEDEF_ISIM_BASE}${stageNum}_hedefIsim`) || `Konum ${stageNum} (Hedef)`;

                 // Tahmin Bilgileri
                 const selectionCountryCode = localStorage.getItem(`${PREFIX}haritaBulmacasi_stage_${stageNum}_selectionCountryCode`) || ''; 
                 const tahminFlag = countryCodeToFlag(selectionCountryCode);
                 const selectionName = localStorage.getItem(`${PREFIX}haritaBulmacasi_stage_${stageNum}_selectionName`) || `Konum ${stageNum} (Se√ßim)`;

                 if (!kaydedilenTahminStr || !kaydedilenHedefStr) {
                     continue; 
                 }

                 const [tahminLat, tahminLng] = kaydedilenTahminStr.split(',').map(p => parseFloat(p.trim()));
                 const [hedefLat, hedefLng] = kaydedilenHedefStr.split(',').map(p => parseFloat(p.trim()));

                 const hedefKonum = { lat: hedefLat, lng: hedefLng };
                 const hedefMarkerStage = new google.maps.Marker({
                     position: hedefKonum,
                     map: tahminHaritasi,
                     title: `[Hedef ${stageNum}] ${hedefName}`,
                     icon: createFlagMarkerIcon(hedefFlag, '#10B981') // Hedef: YE≈ûƒ∞L
                 });
                 tumAsamaMarkerlari.push(hedefMarkerStage);
                 bounds.extend(hedefKonum);

                 const tahminKonum = { lat: tahminLat, lng: tahminLng };
                 const tahminMarkerStage = new google.maps.Marker({
                     position: tahminKonum,
                     map: tahminHaritasi,
                     title: `[Tahmin ${stageNum}] ${selectionName}`,
                     icon: createFlagMarkerIcon(tahminFlag, '#EF4444') // Tahmin: KIRMIZI
                 });
                 tumAsamaMarkerlari.push(tahminMarkerStage);
                 bounds.extend(tahminKonum);

                 const yolKoordinatlari = [tahminKonum, hedefKonum];
                 const mesafeCizgisiStage = new google.maps.Polyline({
                     path: yolKoordinatlari,
                     geodesic: true,
                     strokeColor: '#000000', 
                     strokeOpacity: 0.5,
                     strokeWeight: 2,
                     map: tahminHaritasi
                 });
                 tumAsamaMarkerlari.push(mesafeCizgisiStage); 
             }

             if (tumAsamaMarkerlari.length > 0) {
                 tahminHaritasi.fitBounds(bounds);
             }
         }
          
          function gosterToplamSonuclari() {
             localStorage.setItem(STORAGE_KEY_COMPLETED, 'true'); 
             const tableBody = document.getElementById('sonucTablosuBody');
             const toplamKmElement = document.getElementById('toplamKm');
             let genelToplamKm = 0; 
             let htmlContent = '';

             const FACTOR = 100; 

             for (let i = 0; i < TOTAL_STAGES; i++) {
                 const stageNum = i + 1;
                 
                 const mesafeStr = localStorage.getItem(`${PREFIX}haritaBulmacasi_stage_${stageNum}_mesafe`);
                 let selectionName = localStorage.getItem(`${PREFIX}haritaBulmacasi_stage_${stageNum}_selectionName`) || 'Tahmin Yapƒ±lmadƒ±';
                 
                 const hedefIsimKey = `${STORAGE_KEY_HEDEF_ISIM_BASE}${stageNum}_hedefIsim`;
                 const hedefUlkeKoduKey = `${STORAGE_KEY_HEDEF_ISIM_BASE}${stageNum}_hedefUlkeKodu`;
                 
                 // üëá Hedef ismi localStorage'dan √ßekilir
                 const hedefName = localStorage.getItem(hedefIsimKey) || `Konum ${stageNum} (Hedef)`;
                 const hedefCountryCode = localStorage.getItem(hedefUlkeKoduKey) || ''; 
                 const hedefFlag = countryCodeToFlag(hedefCountryCode); 

                 let mesafeKm = 0;
                 let gosterilecekMesafe = 'Tahmin Yok';
                 let mesafeBirimi = 'km';

                 if (mesafeStr) {
                     mesafeKm = parseFloat(mesafeStr);
                     genelToplamKm += mesafeKm; 

                     // YUVARLAMAYI KALDIRAN (KESEN) BLOK
                     const truncatedMesafe = Math.trunc(mesafeKm * FACTOR) / FACTOR;
                     
                     // T√ºrk√ße Format (Binlik nokta, ondalƒ±k virg√ºl)
                     gosterilecekMesafe = truncatedMesafe.toLocaleString('tr-TR', { 
                         minimumFractionDigits: 2, 
                         maximumFractionDigits: 2 
                     });
                 }
                 
                 htmlContent += `
                      <tr>
                          <td>Konum ${stageNum}</td>
                          <td>${hedefFlag} ${hedefName}</td> 
                          <td>${selectionName}</td>
                          <td class="text-right">${gosterilecekMesafe} ${mesafeBirimi}</td>
                      </tr>
                  `;
             }

             tableBody.innerHTML = htmlContent;
             
             // TOPLAM MESAFE DE YUVARLANMADAN KESƒ∞Lƒ∞R
             const truncatedTotal = Math.trunc(genelToplamKm * FACTOR) / FACTOR;
             
             toplamKmElement.textContent = `${truncatedTotal.toLocaleString('tr-TR', { 
                 minimumFractionDigits: 2, 
                 maximumFractionDigits: 2 
             })} km`;¬†
             
             document.getElementById('sonucTablosuKapsayici').classList.remove('hidden');
             
             // üëá YENƒ∞ EK: Banner √ºzerindeki butonu g√∂ster
             const bannerButonu = document.getElementById('bannerSifirlaButonu');
             if (bannerButonu) {
                bannerButonu.classList.remove('hidden');
             }

             gosterTumAsamaSonuclarini(); 
          }

          function temizleHaritaKatmanlari() {
             if (tahminMarker) tahminMarker.setMap(null);
             if (hedefMarker) hedefMarker.setMap(null);
             if (mesafeCizgisi) mesafeCizgisi.setMap(null);

             tumAsamaMarkerlari.forEach(marker => {
                 if(marker.setMap) marker.setMap(null); 
             });
             tumAsamaMarkerlari = [];
          }


          function pinAtVeKoordinatGuncelle(lat, lng) {
             temizleHaritaKatmanlari(); 
             
             selectedLat = lat;
             selectedLng = lng;

             const tahminKonum = { lat: lat, lng: lng };
             // Tahmin yapƒ±lmadan √∂nce sadece basit bir pin g√∂steriyoruz.
             if (tahminMarker) {
                tahminMarker.setMap(null);
             }
             tahminMarker = new google.maps.Marker({
                 position: tahminKonum,
                 map: tahminHaritasi,
                 title: 'Tahmininiz',
             });
             
             tahminHaritasi.panTo(tahminKonum);
             if (tahminHaritasi.getZoom() < 5) {
                 tahminHaritasi.setZoom(5);
             }
          }

          // √úlke kodlarƒ±nƒ± parametre olarak alƒ±p bayrak ikonlarƒ±nƒ± kullanƒ±r.
          function gosterPinlerVeHaritayiYakƒ±nla≈ütƒ±r(tahminEnlem, tahminBoylam, hedefEnlem, hedefBoylam, selectionCountryCode, hedefCountryCode) {
             if (!tahminHaritasi) return;
             temizleHaritaKatmanlari(); 
             
             const tahminFlag = countryCodeToFlag(selectionCountryCode);
             const hedefFlag = countryCodeToFlag(hedefCountryCode);

             const tahminKonum = { lat: tahminEnlem, lng: tahminBoylam };
             tahminMarker = new google.maps.Marker({ 
                 position: tahminKonum, 
                 map: tahminHaritasi, 
                 title: 'Tahmininiz',
                 icon: createFlagMarkerIcon(tahminFlag, '#EF4444') // Tahmin: KIRMIZI
             });
             
             const hedefKonum = { lat: hedefEnlem, lng: hedefBoylam };
             hedefMarker = new google.maps.Marker({
                 position: hedefKonum,
                 map: tahminHaritasi,
                 title: 'Ger√ßek Konum',
                 icon: createFlagMarkerIcon(hedefFlag, '#10B981') // Hedef: YE≈ûƒ∞L
             });
             
             const yolKoordinatlari = [tahminKonum, hedefKonum];
             mesafeCizgisi = new google.maps.Polyline({
                 path: yolKoordinatlari,
                 geodesic: true, 
                 strokeColor: '#3B82F6', 
                 strokeOpacity: 0.8,
                 strokeWeight: 4,
                 map: tahminHaritasi
             });

             const bounds = new google.maps.LatLngBounds();
             bounds.extend(tahminMarker.getPosition());
             bounds.extend(hedefMarker.getPosition());
             tahminHaritasi.fitBounds(bounds);
          }

          function getDistance(lat1, lon1, lat2, lon2) {
             const R = 6371;
             const deg2rad = (deg) => deg * (Math.PI / 180);
             const dLat = deg2rad(lat2 - lat1);
             const dLon = deg2rad(lon2 - lon1);
             const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                         Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
             const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
             return R * c;
          }

          function startTimer(durationSeconds, display) {
             let startTime = localStorage.getItem(STORAGE_KEY_TIMER_START);
             let totalDuration = localStorage.getItem(STORAGE_KEY_TIMER_DURATION);
             const bodyElement = document.body;

             if (!startTime) {
                 startTime = Date.now();
                 totalDuration = durationSeconds * 1000; 
                 localStorage.setItem(STORAGE_KEY_TIMER_START, startTime);
                 localStorage.setItem(STORAGE_KEY_TIMER_DURATION, totalDuration);
             } else {
                 startTime = parseInt(startTime);
                 totalDuration = parseInt(totalDuration);
             }
             
             uyariGosterildi = false; 

             const stopTimer = () => {
                 clearInterval(kronometreInterval);
                 document.getElementById('tahminButonu').disabled = true;
                 document.getElementById('mesajAlani').innerHTML = "üõë **S√úRE DOLDU!** Tahmin giri≈üi kapatƒ±lmƒ±≈ütƒ±r. Bir sonraki a≈üamaya ge√ßin.";
                 display.textContent = "00:00";
                 display.style.color = "gray";
                 display.classList.remove("animate-pulse");

                 bodyElement.classList.remove('border-alert'); 
                 
                 document.removeEventListener('click', kapatUyariGlobal, true);

                 localStorage.setItem(STORAGE_KEY_TAHMIN, 'true');
                 localStorage.setItem(STORAGE_KEY_MESAFE, '99999');
                 localStorage.setItem(STORAGE_KEY_SELECTION_NAME, 'S√ºre Doldu (99999 km)'); 
                 localStorage.removeItem(STORAGE_KEY_TIMER_START);
                 localStorage.removeItem(STORAGE_KEY_TIMER_DURATION);
                 
                 let currentStage = parseInt(localStorage.getItem(STORAGE_KEY_STAGE));

                 if (currentStage < TOTAL_STAGES) {
                     document.getElementById('sonrakiAsamaButonu').classList.remove('hidden');
                     document.getElementById('sonrakiAsamaButonu').textContent = `üëâ Sonraki Konum (${currentStage + 1}. A≈üama)`;
                 } else {
                     document.getElementById('sonrakiAsamaButonu').classList.remove('hidden');
                     gosterToplamSonuclari();
                     document.getElementById('sonrakiAsamaButonu').textContent = "üîÑ Oyunu Ba≈ütan Ba≈ülat";
                 }
             };

             kronometreInterval = setInterval(function () {
                 const elapsedTime = Date.now() - startTime;
                 let remainingTime = Math.max(0, (totalDuration - elapsedTime) / 1000); 

                 if (remainingTime <= 0) {
                     stopTimer();
                     return;
                 }

                 let minutes = parseInt(remainingTime / 60, 10);
                 let seconds = parseInt(remainingTime % 60, 10);
                 minutes = minutes < 10 ? "0" + minutes : minutes;
                 seconds = seconds < 10 ? "0" + seconds : seconds;
                 display.textContent = minutes + ":" + seconds;
                 
                 // √ñZEL KONTROL UYARISI
                 if (remainingTime <= 30 && !uyariGosterildi) {
                     gosterGeciciUyari(); 
                     uyariGosterildi = true; 
                 }
                 
                 if (remainingTime <= 10 && remainingTime > 0) {
                     display.classList.add("animate-pulse");
                     bodyElement.classList.add('border-alert'); 
                 } else if (remainingTime > 10) {
                     bodyElement.classList.remove('border-alert');
                 }
             }, 1000);
          }
          
        /* =========================================================================
         * YENƒ∞ FONKSƒ∞YON: BANNER SIFIRLAMA ƒ∞≈ûLEMƒ∞ (Parola Kontroll√º)
         * ========================================================================= */
        function oyunuSifirlaParolaIle() {
            const girilenParola = prompt("‚ö†Ô∏è OYUNU SIFIRLAMAK ƒ∞√áƒ∞N 4 HANELƒ∞ PAROLAYI Gƒ∞Rƒ∞Nƒ∞Z:");
                    
            if (girilenParola === SIFIRLAMA_PAROLASI) {
                if (confirm("Oyunu sƒ±fƒ±rlamak istediƒüinizden emin misiniz? T√ºm ilerleme silinecektir.")) {
                    resetGame(); 
                }
            } else if (girilenParola !== null) { 
                alert("‚ùå Hatalƒ± Parola! Sƒ±fƒ±rlama i≈ülemi iptal edildi.");
            }
        }

        function sonrakiAsamayaGec() {
            let currentStage = parseInt(localStorage.getItem(STORAGE_KEY_STAGE));
            if (currentStage < TOTAL_STAGES) {
                
                // Mevcut a≈üamanƒ±n tahmin durumunu temizle
                localStorage.removeItem(`${PREFIX}haritaBulmacasi_stage_${currentStage}_tahminYapildi`);
                
                // Saya√ßlarƒ± ve hareket sayacƒ±nƒ± temizle
                localStorage.removeItem(STORAGE_KEY_TIMER_START);
                localStorage.removeItem(STORAGE_KEY_TIMER_DURATION);
                localStorage.removeItem(STORAGE_KEY_HAREKET_SAYACI);
                
                const nextStage = currentStage + 1;
                localStorage.setItem(STORAGE_KEY_STAGE, nextStage);
                alert(`üéâ ${nextStage}. A≈üama'ya ge√ßiliyor! Yeni harita y√ºkleniyor...`);
                window.location.reload(); 
            } else {
                localStorage.setItem(STORAGE_KEY_COMPLETED, 'true'); 

                if (document.getElementById('sonrakiAsamaButonu').textContent.includes("Ba≈ütan Ba≈ülat")) {
                    // Tahmin Kutusu i√ßindeki butondan sƒ±fƒ±rlama yapƒ±lƒ±yorsa
                    oyunuSifirlaParolaIle();
                    
                } else {
                    alert("üéä Tebrikler! Harita Bulmacasƒ± serisini tamamladƒ±nƒ±z. Yeniden Ba≈ülatmak i√ßin butona tekrar basmalƒ±sƒ±nƒ±z.");
                    document.getElementById('sonrakiAsamaButonu').textContent = "üîÑ Oyunu Ba≈ütan Ba≈ülat";
                    gosterToplamSonuclari();
                }
            }
        }
          
          function resetGame() {
             for (let i = 0; i < TOTAL_STAGES; i++) {
                 const stageNum = i + 1;
                 // Tahmin verilerini temizle
                 localStorage.removeItem(`${PREFIX}haritaBulmacasi_stage_${stageNum}_tahminYapildi`);
                 localStorage.removeItem(`${PREFIX}haritaBulmacasi_stage_${stageNum}_tahminKoordinat`); 
                 localStorage.removeItem(`${PREFIX}haritaBulmacasi_stage_${stageNum}_mesafe`);
                 localStorage.removeItem(`${PREFIX}haritaBulmacasi_stage_${stageNum}_selectionName`);
                 localStorage.removeItem(`${PREFIX}haritaBulmacasi_stage_${stageNum}_selectionCountryCode`); 
                 // Hedef verilerini de temizle (Tekrar kod girilmesi i√ßin)
                 localStorage.removeItem(`${STORAGE_KEY_HEDEF_ISIM_BASE}${stageNum}_hedefEnlem`);
                 localStorage.removeItem(`${STORAGE_KEY_HEDEF_ISIM_BASE}${stageNum}_hedefBoylam`);
                 localStorage.removeItem(`${STORAGE_KEY_HEDEF_ISIM_BASE}${stageNum}_hedefIsim`);¬†
                 localStorage.removeItem(`${STORAGE_KEY_HEDEF_ISIM_BASE}${stageNum}_hedefUlkeKodu`); 
                 localStorage.removeItem(`${STORAGE_KEY_HEDEF_ISIM_BASE}${stageNum}_hedefKoordinat`);
             }
             // Global saya√ßlarƒ± ve durumu temizle
             localStorage.removeItem(STORAGE_KEY_TIMER_START);
             localStorage.removeItem(STORAGE_KEY_TIMER_DURATION);
             localStorage.removeItem(STORAGE_KEY_HAREKET_SAYACI);
             
             localStorage.removeItem(STORAGE_KEY_STAGE);
             localStorage.removeItem(STORAGE_KEY_COMPLETED);
             
             // Sayfayƒ± yeniden y√ºkle
             window.location.reload();
          }
          
    </script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        fontFamily: {
          sans: ['Inter', 'sans-serif'],
        },
        boxShadow: {
          'glow': '0 0 20px rgba(66, 153, 225, 0.5)',
        }
      }
    }
  }
</script>
</body>
</html>